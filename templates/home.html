<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Open Iconic icons -->
    <link rel="stylesheet" href="static/open-iconic/css/open-iconic-bootstrap.min.css" />

    <title>GIFTube</title>
</head>
<body>

<div class="container" id="main-container" style='margin-top:20px'>
    <div class="row" id="search-row">
        <div class="col-sm-12">
            <div class="input-group">
                <input id='search-input' type="text" class="form-control"
                       placeholder="What do you want to immortalize today?" />
                <div class="input-group-append">
                    <button id='search-button' class="btn btn-outline-secondary" type="button">Search</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row" style="margin-top:20px">
        <div class="col-md-8">
            <div class="row">
                <div class="col-sm-12" style="padding:10px">
                    <div id='youtube-player-wrapper' style='width:100%;display:none'>
                        <div id="youtube-player"></div>
                    </div>
                </div>
            </div>
            <div class="row" id="control-group" style="display:none">
                <div class="col-sm-12">
                    <div class="row" style="margin-bottom:15px">
                        <div class="col-sm-10">
                            <input type="range" min="0" max="100" value="0" style="width:100%" id="video-slider"/>
                        </div>
                        <div class="col-sm-2">
                            <input type="text" class="form-control" value="0s" id="video-slider-display" disabled />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">Duration</span>
                                    </div>
                                    <input class="form-control" id="video-duration" type="text" value="2" />
                                    <div class="input-group-append">
                                        <button id="duration-minus" class="btn btn-outline-secondary" type="button" style="width:40px">-</button>
                                        <button id="duration-plus" class="btn btn-outline-secondary" type="button" style="width:40px">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row"">
                        <div class="col-sm-12">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class='input-group-text'>Caption</span>
                                </div>
                                <input id='caption-input' type="text" class="form-control" value='' />
                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top:15px">
                        <div class="col-sm-4 d-flex justify-content-center">
                            <button class="btn btn-primary" id="play-btn">Play</button>
                        </div>
                        <div class="col-sm-4 d-flex justify-content-center">
                            <button class="btn btn-primary" id="bookmark-btn">Bookmark</button>
                        </div>
                        <div class="col-sm-4 d-flex justify-content-center">
                            <button class="btn btn-primary" id="gif-btn">Make GIF</button>
                        </div>
                    </div>
                    <div class="row" style="margin-top:15px">
                        <div class="col-sm-12" id="bookmark-section" style="overflow-y:scroll">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div id="search-results" style="height:200px; overflow-y:scroll">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="progress-modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generating your GIF...</h5>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>

{% raw %}
<script id="search-result-template" type="text/x-handlebars-template">
    {{#each items}}
    <div class="card youtube-card" videoId="{{id.videoId}}" videoTitle="{{snippet.title}}" style="margin-bottom:10px">
        <img class="card-img-top" src={{snippet.thumbnails.medium.url}}></img>
        <div class="card-body">
            <h6 class="card-title">{{snippet.title}}</h6>
        </div>
    </div>
    {{/each}}
</script>

<script id="bookmark-table-template" type="text/x-handlebars-template">
<table class="table">
    <tr>
        <th>Title</th>
        <th>Start</th>
        <th>Duration</th>
        <th></th>
    </tr>
    {{#each this}}
    <tr>
        <td>{{title}}</td>
        <td>{{start}}s</td>
        <td>{{duration}}s</td>
        <td><a class="bookmark-play" href="#" forItemIdx="{{@index}}"><span class="oi oi-media-play" title="media-play" aria-hidden="true"></span></a></td>
    </tr>
    {{/each}}
</table>
</script>
{% endraw %}

<script>
// API key from backend
var api_key = '{{ ctx.api_key }}';

{% raw %}
var searchResultTemplate = undefined;
var bookmarkTableTemplate = undefined;

// Load and set up YouTube iFrame Player API
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var playSecs = 0;
var snippetPlaying = false;
var updateMaxSecs = false;

var youtubePlayer = undefined;

var savedSnippets = [];
var currentStart = 0;
var currentDuration = 2;

var updateSliderVal = (val) => {
    $('#video-slider').val(currentStart);
    $('#video-slider-display').val(val + 's');
}

function onPlayerStateChange(event) {
    console.log(event);
    if (event.data == 1) {
        if (updateMaxSecs) {
            console.log(youtubePlayer.getDuration());
            $("#video-slider").attr('max', parseInt(youtubePlayer.getDuration()));
            updateSliderVal(currentStart);
            $('#video-duration').val(currentDuration);
        }
        if (snippetPlaying) {
            setTimeout(() => {
                youtubePlayer.pauseVideo();
            }, playSecs * 1000);
            snippetPlaying = false;
        }
    }
}

function onYouTubeIframeAPIReady() {
    var wrapperWidth = $('#youtube-player-wrapper').width() - 20;
    var wrapperHeight = wrapperWidth / 16.0 * 9.0;
    youtubePlayer = new YT.Player('youtube-player', {
        width: wrapperWidth,
        height: wrapperHeight,
        events: {
            onReady: () => {youtubePlayer.mute();},
            onStateChange: onPlayerStateChange
        }
    });
}

var currentVideoId = '';
var currentVideoTitle = '';

var loadVideo = (videoId, videoTitle, cb=undefined) => {
    youtubePlayer.loadVideoById({
        'videoId': videoId,
        'suggestedQuality': 'large',
        'endSeconds': 0
    });
    currentVideoId = videoId;
    currentVideoTitle = videoTitle;
    currentStart = 0;
    updateMaxSecs = true;
    youtubePlayer.playVideo();
    setTimeout(() => {
        youtubePlayer.stopVideo();
        if(cb) {
            cb();
        }
    }, 1000);
}

var playSavedSnippet = (snippet) => {
    youtubePlayer.loadVideoById({
        'videoId': snippet.videoId,
        'suggestedQuality': 'large',
        'endSeconds': 0
    });
    updateMaxSecs = true;
    snippetPlaying = true;
    currentVideoId = snippet.videoId;
    currentStart = snippet.start;
    currentDuration = snippet.duration;
    $('#caption-input').val(snippet.caption);
    playVideoSegment(snippet.videoId, snippet.title, snippet.start, snippet.duration);
}

var searchAction = () => {
    gapi.client.youtube.search.list({
        'part': 'snippet',
        'maxResults': 25,
        'q': $('#search-input').val().toLowerCase(),
        'safesearch': 'none',
        'type': 'video'
    }).then((response) => {
        $('#search-results').html(searchResultTemplate(response.result));

        youtubePlayer.mute();
        $('#youtube-player-wrapper').show();
        loadVideo(response.result.items[0].id.videoId, response.result.items[0].snippet.title);

        $('#control-group').show();

        $('.youtube-card').click((event) => {
            //console.log($(event.currentTarget).attr('videoId'));
            loadVideo($(event.currentTarget).attr('videoId'), $(event.currentTarget).attr('videoTitle'));
        });

        var bookmarkTopOffet = $('#bookmark-section')[0].getBoundingClientRect().top;
        console.log(bookmarkTopOffet);
        $('#bookmark-section').height($(window).height() - bookmarkTopOffet);

        var searchResultTopOffset = $('#search-results')[0].getBoundingClientRect().top;
        $('#search-results').height($(window).height() - searchResultTopOffset);
    });
};

var playVideoSegment = (videoId, videoTitle, start, duration) => {
    if(videoId != currentVideoId) {
        loadVideo(videoId, videoTitle, () => {
            console.log('here is the callback ' + start + ' ' + duration);
            youtubePlayer.seekTo(start);
            snippetPlaying = true;
            playSecs = duration;
            youtubePlayer.playVideo();
        });
    } else {
        youtubePlayer.seekTo(start);
        snippetPlaying = true;
        playSecs = duration;
        youtubePlayer.playVideo();
    }
}

var videoInfoAction = () => {
    gapi.client.youtube.videos.list({
        'part': 'contentDetails',
        'id': currentVideoId
    }).then((response) => {
        console.log(response);
    })
}

var APILoaded = () => {
    gapi.client.init({
        'apiKey': api_key,
        'discoveryDocs': ["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest"],
    }).then(() => {
        $('#search-button').click(searchAction);
    });
};

var saveSnippet = (snippetInfo) => {
    savedSnippets.push(snippetInfo);
    $('#bookmark-section').html(bookmarkTableTemplate(savedSnippets))
    $('a.bookmark-play').click((event) => {
        var idx = parseInt($(event.target).parent().attr('forItemIdx'));
        playSavedSnippet(savedSnippets[idx]);
    });
};

$(document).ready(function () {
    searchResultTemplate = Handlebars.compile($('#search-result-template').html());
    bookmarkTableTemplate = Handlebars.compile($('#bookmark-table-template').html());

    gapi.load('client', APILoaded);

    $('#play-btn').click(function () {
        playVideoSegment(currentVideoId, currentVideoTitle, currentStart, currentDuration);
    });

    $('#progress-modal').modal('hide');

    $('#gif-btn').click(() => {
        $('#progress-modal').modal('show');
        $.ajax({
            method: 'POST',
            url: '/makegif',
            data: {
                "videoId": currentVideoId,
                "start": currentStart,
                "duration": currentDuration,
                "caption": $('#caption-input').val()
            },
            success: (response) => {
                console.log(response);
                if (response != "Doesn't look like anything to me.") {
                    var gifurl = '/downloadgif/' + response;
                    var linktag = document.createElement('a');
                    linktag.setAttribute('href', gifurl);
                    linktag.setAttribute('download', response);
                    console.log(linktag);
                    linktag.click();
                }
                $('#progress-modal').modal('hide');
            }
        });
    });

    $('#video-slider').change(() => {
        console.log($('#video-slider').val());
        currentStart = parseFloat($('#video-slider').val());
        currentDuration = parseFloat($('#video-duration').val());
        playVideoSegment(currentVideoId, currentVideoTitle, currentStart, currentDuration);
    });

    $('#video-slider').on('input', () => {
       $('#video-slider-display').val($('#video-slider').val() + 's');
    });

    $('#duration-plus').click(() => {
        var currentVal = parseFloat($('#video-duration').val());
        $('#video-duration').val(currentVal + 1);
        currentStart = parseFloat($('#video-slider').val());
        currentDuration = parseFloat($('#video-duration').val());
        playVideoSegment(currentVideoId, currentVideoTitle, currentStart, currentDuration);
    });

    $('#duration-minus').click(() => {
        var currentVal = parseFloat($('#video-duration').val());
        if(currentVal > 0) {
            $('#video-duration').val(currentVal - 1);
        }
        currentStart = parseFloat($('#video-slider').val());
        currentDuration = parseFloat($('#video-duration').val());
        playVideoSegment(currentVideoId, currentVideoTitle, currentStart, currentDuration);
    });

    $('#video-duration').change(() => {
        currentStart = parseFloat($('#video-slider').val());
        currentDuration = parseFloat($('#video-duration').val());
        playVideoSegment(currentVideoId, currentVideoTitle, currentStart, currentDuration);
    });

    $('#bookmark-btn').click(() => {
        saveSnippet({
            title: currentVideoTitle,
            videoId: currentVideoId,
            start: currentStart,
            duration: currentDuration,
            caption: $('#caption-input').val()
        });
    });
});
{% endraw %}
</script>
</body>
</html>
